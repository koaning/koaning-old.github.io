  <meta name='viewport' content="width=device-width">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.1/d3.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="/js/prism.js"></script>

    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="../css/bootstrap3.css">
    <link rel="stylesheet" href="../css/prism.css">
    <link rel="stylesheet" href="../css/style.css"></link>
  <style>
  body {
    padding-top: 30px;
  }
  .starter-template {
    padding: 40px 15px;
    text-align: center;
  }
  pre{
    border:0px;
    border-radius: 0px; 
  }
  code{
    background-color: #f5f5f5;
    color: black;
  }

  iframe.graph{
    border: 0;
      display: block;
      margin-left: auto;
      margin-right: auto;
  }
</style>

<div class="container">
  <div class="row">
    <div class="starter-template">
      
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <h1>Creating a Cloudy Leaflet</h1>
      <p>In this small document I will describe how to make dynamic clouds appear on a leaflet map using d3. The clouds themselves won't be too interesting, but the techniques of drawing them are. The steps described here might also help you make more dynamic maps yourself that go beyond a standard example.</p>
      <h2>Creating a Cloud.</h2>
      <p>The cloud that we want to create will consist of several circles that together form a cloud that has a shaded opacity. You need to apply a css-trick to get this to work properly. Consider the following started code:</p>
    </div>
    <div class="col-md-6">
      <h4>javascript</h4>
<pre><code class="language-javascript">var circle_data = [
  [10,70,10],
  [20,25,10],
  [70,35,10],
  [50,45,20],
  [20,55,20],
  [30,45,25]
];

var cloud1 = d3.select("#cloud1").append("svg");

cloud1.selectAll("circles")
  .data(circle_data).enter()
  .append("circle")
  .attr("class","cloud1")
  .attr("cx", function(d){return d[0]})
  .attr("cy", function(d){return d[1]})
  .attr("r", function(d){return d[2]})
  .style("fill", "steelblue")
  .style("fill-opacity", 0.5);
</code></pre>
    </div>

    <div class="col-md-6">
      <h4>result</h4>
      <div id="cloud1"></div>
    </div>
    <script>
var circle_data = [
  [10,70,10],
  [20,25,10],
  [70,35,10],
  [50,45,20],
  [20,55,20],
  [30,45,25]
];

var cloud1 = d3.select("#cloud1").append("svg")
    .attr("width","100%")
    .attr("height",110);

cloud1.selectAll("circles")
  .data(circle_data).enter()
  .append("circle")
  .attr("class","cloud1")
  .attr("cx", function(d){return d[0]})
  .attr("cy", function(d){return d[1]})
  .attr("r", function(d){return d[2]})
  .style("fill", "steelblue")
  .style("fill-opacity", 0.5);
</script>

  <div class="col-md-12">
    <p>There are two main downsides to this approach.</p>
    <ul>
      <li>The opacity change is applied to individual circles and not to the entire cloud.</li>
      <li>If we want to animate the cloud in the future we would need to apply the same animation to six different elements.</li>
    </ul>
    <p>A better approach would be to have these circles in a group. That way we can apply the css rule as well as the animation to the group.</p>
  </div>
    <div class="col-md-6">
      <h4>javascript</h4>
<pre><code class="language-javascript">var cloud2 = d3.select("#cloud2").append("svg")
  .attr("width","100%")
  .attr("height",200);

var group = cloud2.append("g")
  .style("opacity", 0.5)
  .style("fill", "steelblue");

group.selectAll("circles")
  .data(circle_data).enter()
  .append("circle")
  .attr("class","cloud1")
  .attr("cx", function(d){return d[0]})
  .attr("cy", function(d){return d[1]})
  .attr("r", function(d){return d[2]})
  .style("fill", "steelblue");
</code></pre>
    </div>
    <div class="col-md-6">
      <h4>result</h4>
      <div id="cloud2"></div>
    </div>

<script>
var cloud2 = d3.select("#cloud2").append("svg")
  .attr("width","100%")
  .attr("height",110);

var group = cloud2.append("g")
  .style("opacity", 0.5)
  .style("fill", "steelblue");

group.selectAll("circles")
  .data(circle_data).enter()
  .append("circle")
  .attr("class","cloud1")
  .attr("cx", function(d){return d[0]})
  .attr("cy", function(d){return d[1]})
  .attr("r", function(d){return d[2]});
</script>

<div class="col-md-12">
  <p>This is much nicer. This we we only need to apply an animation to the group object instead of the seperate circle objects.</p>
</div>

  <div class="col-md-6">
      <h4>javascript</h4>
<pre><code class="language-javascript">setInterval( function(){
  group.transition()
    .attr("transform", "translate(" + Math.random() * 200 + ", 0)")
}, 1000)
</code></pre>
    </div>
    <div class="col-md-6">
      <h4>result</h4>
      <div id="cloud3"></div>
    </div>

<script>
var cloud3 = d3.select("#cloud3").append("svg")
  .attr("width","100%")
  .attr("height",110);

var group = cloud3.append("g")
  .style("opacity", 0.5)
  .style("fill", "steelblue");

group.selectAll("circles")
  .data(circle_data).enter()
  .append("circle")
  .attr("class","cloud1")
  .attr("cx", function(d){return d[0]})
  .attr("cy", function(d){return d[1]})
  .attr("r", function(d){return d[2]})
  .style("fill", "steelblue");

setInterval( function(){
  group.transition()
    .attr("transform", "translate(" + Math.random() * 200 + ", 0)")
}, 1000)
</script>

<div class="col-md-12">
  <h2>Dealing with Leaflet</h2>
  <p>It might be useful to review Mike Bostocks <a href="http://bost.ocks.org/mike/leaflet/">tutorial</a> on how to combine leaflet with d3 before moving on. We need to append svg elements to a leaflet layer. Keep in mind that we need to alter our coordinates to fit to the surface of the round earth. Also, we will not be using geojson to these clouds, but we will be using a simple array instead.</p>
  <p>The first step is to make sure we can plot a few simple points on the map without using geojson.</p>

  <h3>Start up Leaflet</h3>

  <p>The first thing we will need to do is initialize leaflet.</p>

  <pre><code class="language-javascript">var circles = [[52.3667,4.90000],[52.6667,5.10000],[52.1, 4.8],[52.08,5.11],[51.9167, 4.5000]];

var map = L.map('map').setView([52.3667,4.90000], 8);

L.tileLayer(
  'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy + Openstreetmap Contributors',
  maxZoom: 18,
}).addTo(map);

map._initPathRoot();</code></pre>

<p>You use whatever tileserver you want (you could even make your own tiles!). I am using openstreetmaps which offers tiles completely for free. Note that I am being a good citizen here and that I am attributing openstreetmaps, you should too if you use their tiles. If you prefer more options for design I highly recommend you take a look at mapbox but be aware that you might need to pay for their service.</p>

<h3>Circles on a Map</h3>


<div class="row">
  <div class="col-md-6">
<p>The following code creates a map with transparant points on the map.</p>
<pre><code class="language-javascript">var svg = d3.select("#map").select("svg"),
    g = svg.append("g");
    
  circles.forEach(function(d) {
    d.LatLng = new L.LatLng(d[0],d[1])
  });

  var links = _.rest(circles).map( function(d){
    return [_.first(circles), d ]
  })

  var feature = g.selectAll("circle")
    .data(circles)
    .enter().append("circle")
    .style("fill", "orange")
    .style("fill-opacity",0.7)
    .attr("r", 10)
    .on("click", function(d){
      alert(d)
    });
  
  map.on("viewreset", update);

  update();

  function update(){
    feature.attr("transform", 
    function(d) { 
      return "translate("+ 
        map.latLngToLayerPoint(d.LatLng).x +","+ 
        map.latLngToLayerPoint(d.LatLng).y +")";
      }
    )
  }</code></pre>
    
  </div>
  <div class="col-md-6">
<p>The full source of this map can be found <a href="http://bl.ocks.org/koaning/bf0c84b37f3b37870c03">here</a>.</p>

<iframe src="cloudyleaflet/circles.html" width="100%" height="600px" marginheight="0" scrolling="no" frameborder="0"></iframe>
    
  </div>
  
  <div class="col-md-12">
  <br>
  <h3>Opacity and Movement</h3>

  <p>To emphesize that the overlap also works on the map I've made the circles larger. Also notice that I've implemted movement of the group where the circles are in.</p>
  </div>

  <div class="col-md-6">
<pre><code class="language-javascript">g.style("opacity", 0.5)

function move(duration){
  feature.transition().attr("transform", 
  function(d){ 
    return "translate("+ 
      (map.latLngToLayerPoint(d.LatLng).x + 100) +","+ 
      map.latLngToLayerPoint(d.LatLng).y +")"
    }
  ).duration(duration).ease("linear")
}</code></pre>
  </div>
  <div class="col-md-6">
<iframe src="cloudyleaflet/circles2.html" width="100%" height="600px" marginheight="0" scrolling="no" frameborder="0"></iframe>
  </div>
</div>
</div>

</p>



  <div class="col-md-12">
  <a href="/">back to main</a>
    <div id="disqus_thread"></div>
      <script type="text/javascript">
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'koaningcom'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28011256-3', 'auto');
  ga('send', 'pageview');

</script>